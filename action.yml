name: "BakeFoundry SAST Scan (CodeQL)"
description: "Composite action to run CodeQL SAST analysis and post findings as a PR comment"

inputs:
  languages:
    description: >
      Comma-separated list of languages to scan (required).
      Supported: javascript, python, java, cpp, csharp, go, ruby, swift
    required: true
  build-mode:
    description: |
      Build mode for CodeQL analysis.
      - none     : for interpreted languages (Python, JavaScript, Ruby) â€” DEFAULT
      - autobuild: for compiled languages (Java, C#, C++, Go) â€” CodeQL auto-detects build
      - manual   : for compiled languages with a custom build command (set build-command too)
    required: false
    default: "none"
  build-command:
    description: "Build command for compiled languages (required when build-mode is manual)"
    required: false
    default: ""
  severity-threshold:
    description: "Minimum severity to fail the build: critical, high, medium, low, note"
    required: false
    default: "high"
  github-token:
    description: "GitHub token for posting PR comments and uploading SARIF results"
    required: true

outputs:
  sarif-file:
    description: "Path to the generated SARIF results file"
    value: ${{ steps.set-output.outputs.sarif-file }}
  findings-count:
    description: "Number of security findings discovered"
    value: ${{ steps.parse-results.outputs.findings-count }}
  critical-count:
    description: "Number of critical security findings discovered"
    value: ${{ steps.parse-results.outputs.critical-count }}

runs:
  using: "composite"
  steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STEP 1: Initialize CodeQL
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: "âš™ï¸ Initialize CodeQL"
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ inputs.languages }}
        # Use the security-extended query suite for broader coverage
        queries: security-extended
        # build-mode controls how CodeQL traces compiled languages
        build-mode: ${{ inputs.build-mode }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STEP 2: Auto-build (only when build-mode is autobuild)
    #   Skipped when build-mode=manual â€” caller is expected
    #   to have already run their own build steps before
    #   invoking this action.
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: "ğŸ”¨ Auto-Build (Compiled Languages)"
      if: ${{ inputs.build-mode == 'autobuild' }}
      uses: github/codeql-action/autobuild@v4

    - name: "ğŸ”¨ Manual Build (Compiled Languages)"
      if: ${{ inputs.build-mode == 'manual' }}
      shell: bash
      run: ${{ inputs.build-command }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STEP 3: Run CodeQL Analysis
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: "ğŸ”¬ Run CodeQL Analysis"
      id: codeql-analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:${{ inputs.languages }}"
        output: sarif-results
        upload: false   # We upload manually after parsing

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STEP 4: Parse SARIF results and count findings
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: "ğŸ“Š Parse SARIF Results"
      id: parse-results
      shell: bash
      run: |
        SARIF_FILE=$(find sarif-results -name "*.sarif" | head -1)
        echo "sarif-file=$SARIF_FILE" >> "$GITHUB_OUTPUT"

        if [ -z "$SARIF_FILE" ] || [ ! -f "$SARIF_FILE" ]; then
          echo "âš ï¸ No SARIF file found. Analysis may have found nothing, or build failed."
          echo "findings-count=0" >> "$GITHUB_OUTPUT"
          echo "critical-count=0" >> "$GITHUB_OUTPUT"
          echo "high-count=0" >> "$GITHUB_OUTPUT"
          echo "medium-count=0" >> "$GITHUB_OUTPUT"
          echo "low-count=0" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "ğŸ“„ Parsing SARIF file: $SARIF_FILE"

        # Count findings by severity
        # 1. Critical: level == error and severity matches "critical"
        CRITICAL=$(jq '[.runs[].results[] | select(.level == "error" and (.rule.properties["problem.severity"] // "" | test("critical"; "i")))] | length' "$SARIF_FILE" 2>/dev/null || echo 0)

        # 2. High: level == error but not critical
        HIGH=$(jq "[.runs[].results[] | select(.level == \"error\" and ((.rule.properties[\"problem.severity\"] // \"\") | test(\"critical\"; \"i\") | not))] | length" "$SARIF_FILE" 2>/dev/null || echo 0)

        # 3. Medium: level == warning
        MEDIUM=$(jq '[.runs[].results[] | select(.level == "warning")] | length' "$SARIF_FILE" 2>/dev/null || echo 0)

        # 4. Low/Other: everything else (note, none, or missing level)
        # We calculate this as TOTAL - (CRITICAL + HIGH + MEDIUM) to ensure mathematical consistency
        TOTAL=$(jq '[.runs[].results[]] | length' "$SARIF_FILE" 2>/dev/null || echo 0)
        LOW=$((TOTAL - CRITICAL - HIGH - MEDIUM))

        echo "critical-count=$CRITICAL" >> "$GITHUB_OUTPUT"
        echo "high-count=$HIGH" >> "$GITHUB_OUTPUT"
        echo "medium-count=$MEDIUM" >> "$GITHUB_OUTPUT"
        echo "low-count=$LOW" >> "$GITHUB_OUTPUT"
        echo "findings-count=$TOTAL" >> "$GITHUB_OUTPUT"

        echo "ğŸ“ˆ Findings Summary:"
        echo "  ğŸ”´ Critical : $CRITICAL"
        echo "  ğŸ”´ High     : $HIGH"
        echo "  ğŸŸ  Medium   : $MEDIUM"
        echo "  ğŸŸ¡ Low      : $LOW"
        echo "  ğŸ“¦ Total    : $TOTAL"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STEP 6: Post PR Comment with findings summary
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: "ğŸ’¬ Post PR Comment"
      if: github.event_name == 'pull_request'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token }}
        TOTAL: ${{ steps.parse-results.outputs.findings-count }}
        CRITICAL: ${{ steps.parse-results.outputs.critical-count }}
        HIGH: ${{ steps.parse-results.outputs.high-count }}
        MEDIUM: ${{ steps.parse-results.outputs.medium-count }}
        LOW: ${{ steps.parse-results.outputs.low-count }}
        LANGS: ${{ inputs.languages }}
      run: |
        PR_NUMBER="${{ github.event.pull_request.number }}"
        REPO="${{ github.repository }}"
        RUN_URL="https://github.com/$REPO/actions/runs/${{ github.run_id }}"
        SECURITY_URL="https://github.com/$REPO/security/code-scanning"

        if [ "$TOTAL" -eq 0 ]; then
          ICON="âœ…"
          STATUS_LINE="**No security vulnerabilities found!** Your code looks clean. ğŸ‰"
        elif [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
          ICON="ğŸ”´"
          STATUS_LINE="**Action Required:** High or Critical severity vulnerabilities detected."
        else
          ICON="ğŸŸ "
          STATUS_LINE="**Review Recommended:** Medium/low severity findings detected."
        fi

        COMMENT_BODY=$(cat <<EOF
        ## $ICON CodeQL SAST Scan Results

        $STATUS_LINE

        | Severity | Count |
        |----------|-------|
        | ğŸ”´ **Critical** | **$CRITICAL** |
        | ğŸ”´ High | $HIGH |
        | ğŸŸ  Medium | $MEDIUM |
        | ğŸŸ¡ Low | $LOW |
        | **Total** | **$TOTAL** |

        **Languages Scanned:** \`$LANGS\`
        **Query Suite:** \`security-extended\`

        > ğŸ“‹ **Full Details:** [View in GitHub Security Tab]($SECURITY_URL) | [View Workflow Run]($RUN_URL)
        >
        > ğŸ’¡ CodeQL checks for SQL injection, XSS, path traversal, command injection, and 250+ more vulnerability types.
        EOF
        )

        # Post or update existing comment
        EXISTING_COMMENT_ID=$(gh api \
          "/repos/$REPO/issues/$PR_NUMBER/comments" \
          --jq '.[] | select(.body | contains("CodeQL SAST Scan Results")) | .id' \
          2>/dev/null | head -1)

        if [ -n "$EXISTING_COMMENT_ID" ]; then
          gh api --method PATCH \
            "/repos/$REPO/issues/comments/$EXISTING_COMMENT_ID" \
            --field body="$COMMENT_BODY" > /dev/null
          echo "âœ… Updated existing SAST comment #$EXISTING_COMMENT_ID"
        else
          gh api --method POST \
            "/repos/$REPO/issues/$PR_NUMBER/comments" \
            --field body="$COMMENT_BODY" > /dev/null
          echo "âœ… Posted new SAST comment on PR #$PR_NUMBER"
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STEP 7: Fail build if threshold exceeded
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: "ğŸš¦ Quality Gate"
      shell: bash
      run: |
        THRESHOLD="${{ inputs.severity-threshold }}"
        CRITICAL="${{ steps.parse-results.outputs.critical-count }}"
        HIGH="${{ steps.parse-results.outputs.high-count }}"
        MEDIUM="${{ steps.parse-results.outputs.medium-count }}"
        LOW="${{ steps.parse-results.outputs.low-count }}"
        TOTAL="${{ steps.parse-results.outputs.findings-count }}"

        echo "ğŸ”’ Severity Threshold: $THRESHOLD"
        echo "ğŸ“Š Findings â€” Critical: $CRITICAL | High: $HIGH | Medium: $MEDIUM | Low: $LOW"

        FAIL=0

        case "$THRESHOLD" in
          critical)
            [ "$CRITICAL" -gt 0 ] && FAIL=1 ;;
          high)
            [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ] && FAIL=1 ;;
          medium)
            [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ] || [ "$MEDIUM" -gt 0 ] && FAIL=1 ;;
          low|note)
            [ "$TOTAL" -gt 0 ] && FAIL=1 ;;
        esac

        if [ "$FAIL" -eq 1 ]; then
          echo ""
          echo "âŒ QUALITY GATE FAILED: Findings exceed the '$THRESHOLD' severity threshold."
          echo "   Please review the GitHub Security tab or the PR comment for details."
          echo "   Security Tab: https://github.com/${{ github.repository }}/security/code-scanning"
          exit 1
        else
          echo "âœ… QUALITY GATE PASSED: No findings at or above '$THRESHOLD' severity."
        fi
